--------------------------------------------- 作者：叶江涛-- 说明：副本选择界面-- 时间：2014-1-8-------------------------------------------local mCurFB = {}  ---当前副本群 的所有副本local mHasPass = 0 --已经过了几关？LayerInstanceSelect = {}local mInstanceSelcetRoot = nil LayerAbstract:extend(LayerInstanceSelect)local ScrollView_InstanceSelect = nilLayerInstanceSelect.onClick = function(widget)	endlocal function 	initButtonEvent()	endlocal function initInstanceScroll()	endlocal function Handle_req_enterGamee(resp)--[[	if resp.result == enter_game_result["enter_game_failed"] then		print("Enter game failed")	elseif resp.result == enter_game_result["enter_game_success"] then		FightDateCache.initGameDate(resp.gamemaps,resp.game_id)	--初始化战斗数据		UIManager.destroyAllUI()		StartLoading()	elseif resp.result == enter_game_result["enter_game_unlogin"] then		print("no register")	end	]]--endlocal deblocInstance = nil   -- 解锁IDlocal curID  = nil  -- 当前副本群ID-- 为ScrollView创建Itemlocal function Handle_game_copy(resp)	print(resp.last_copy_id)	deblocInstance = resp.last_copy_id	-- 创建Item	CreateInstanceItem(curID)endLayerInstanceSelect.onClick = function(widget)	local widgetName = widget:getName()    --if "Button_52" == widgetName then  -- 返回键		--UIManager.pop("UI_InstanceSelect")  -- 跳到主界面	--endendLayerInstanceSelect.onItemClick = function(parent,pos)	print(pos,"mHasPass",mHasPass)	if pos <= mHasPass then					local tb = req_enter_game()		tb.id = ModelPlayer.getId()		tb.gametype = 1				-- 1 为进入主线副本		tb.copy_id = getCurFBId(pos)		FightDateCache.curFB_ID = tb.copy_id		NetHelper.sendAndWait(tb, NetMsgType["msg_notify_enter_game"])	endend-- 初始化 当前副本群的所有副本function initCurGroud(curId)	mCurFB = {}	--print ( "initCurGroud(curId)",curId) 	local fbGround = LogicTable.getGameAllFB() --获取副本的XML表	for key,value in pairs(fbGround) do		print("value.copy_group_id",value.copy_group_id)		if curId == value.copy_group_id then			table.insert(mCurFB,value)		end	endendfunction getCurFBId(pos)	for k,v in pairs(mCurFB) do		if (pos+1) == k then			print(v.id)			return v.id		end 	endend-- 展示每个关卡的获得的星星数量local function setLvStarRender(itemContent,starNumber)	--local star1 = itemContent:getChildByName("star1")	local star1 = itemContent:getChildByTag(13)	local star2 = itemContent:getChildByTag(23)	local star3 = itemContent:getChildByTag(33)	tolua.cast(star1,"UIImageView") 	tolua.cast(star2,"UIImageView") 	tolua.cast(star3,"UIImageView") 	if starNumber == 0  then		return	elseif starNumber == 1  then		star1:loadTexture("starfb.png")	elseif starNumber == 2  then		--star1:loadTexture("star0.png")		star1:loadTexture("star1.png",UI_TEX_TYPE_PLIST);		star2:loadTexture("star1.png",UI_TEX_TYPE_PLIST);		--star2:loadTexture("star0.png")	elseif starNumber == 3  then		star1:loadTexture("starfb.png")		star2:loadTexture("starfb.png")		star3:loadTexture("starfb.png")	endendlocal function onclickCanCle(Type,widgetName)	print(Type,widgetName)	if Type == "releaseUp" then 		setConententPannelJosn(LayerLevelSelcet,"fuBen")	end end-- onCreate--参数 ：curId 当前FB群ID hadNum 当前副本通关数量LayerInstanceSelect.init = function (ScorllView,curId,hadNum)	-- 注册监听	NetSocket_registerHandler(NetMsgType["msg_notify_enter_game"], notify_enter_game(), Handle_req_enterGamee)	--cancle button	local buttonCancle = UIManager.getRunLayer():getWidgetByName("Button_zhuxian")	buttonCancle:registerEventScript(onclickCanCle)	buttonCancle:setVisible(true)	ScorllView:removeAllChildren()	initCurGroud(curId)	mCurFbid = curId	mHasPass = hadNum	local ScrollItem = {}   -- 存放scroll item对应的表	for k,v in pairs(mCurFB) do		local itemContent = GUIReader:shareReader():widgetFromJsonFile("fubenItem_1.ExportJson")		itemContent:setAnchorPoint(ccp(0.5,0.5))		--bg		if k > (mHasPass +1) then 			itemContent:setTouchEnabled(false)			local itemBg = itemContent:getChildByName("ImageView_22")			tolua.cast(itemBg,"UIImageView")			itemBg:loadTexture("points_nopass.png")		else			itemContent:setTouchEnabled(true)		end		--set Fb Name		local nameText = itemContent:getChildByName("Label_28")		tolua.cast(nameText, "UILabel")		nameText:setText(v.name)		--Player Gold		local moneyTest = itemContent:getChildByName("LabelAtlas_29_0")-- 金币		tolua.cast(moneyTest,"UILabelAtlas") 		moneyTest:setStringValue(v.gold)		--star 		--print ("本关星星","key",k,LayerLevelSelcet.getScoreById( tonumber(v.id)))		setLvStarRender(itemContent,LayerLevelSelcet.getScoreById(tonumber(v.id)))		table.insert(ScrollItem,itemContent)	end	setListViewAdapter(LayerInstanceSelect,ScorllView,CommonFunc_InvertedTable(ScrollItem),"V") end