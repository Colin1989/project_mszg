------------------------------------------------------------------------ 作者：hezhr-- 日期：2013-11-27-- 描述：脚本入口---------------------------------------------------------------------------------------------------------------------------------------------- 全局变量LANGUAGE = "Cn"g_rootNode = CCScene:create()			-- 当前运行的游戏根节点g_sceneUIRoot = CCLayer:create()		-- 战斗UI场景父节点g_sceneRoot = CCLayer:create()			-- 战斗场景的父节点g_uiRoot = CCLayer:create()				-- 游戏界面的父节点local mUpdateId = nil------------------------------------------------------------------------ 设置搜索路径local function setSearchPath()	-- 设置lua文件搜索路径	CCFileUtils:sharedFileUtils():addSearchPath("Script")	CCFileUtils:sharedFileUtils():addSearchPath("Script/Xml")	CCFileUtils:sharedFileUtils():addSearchPath("Script/Socket")	CCFileUtils:sharedFileUtils():addSearchPath("Script/Network")	CCFileUtils:sharedFileUtils():addSearchPath("Script/GameEvent")	CCFileUtils:sharedFileUtils():addSearchPath("Script/gamelayer")	CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule")    CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/buff")    CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/Role")	CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/RoleAI")	CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/Effect")	CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/Grid")	CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/Layer")	CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/Skill")	CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/Battle")    CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/talent")	CCFileUtils:sharedFileUtils():addSearchPath("Script/FightModule/AI")	CCFileUtils:sharedFileUtils():addSearchPath("Script/gameModel")	CCFileUtils:sharedFileUtils():addSearchPath("Script/GameSkill")	CCFileUtils:sharedFileUtils():addSearchPath("Script/Friend")	CCFileUtils:sharedFileUtils():addSearchPath("Script/gamelayer/Backpack")	CCFileUtils:sharedFileUtils():addSearchPath("Script/gamelayer/EquipForge")	CCFileUtils:sharedFileUtils():addSearchPath("Script/CommonLayer")	CCFileUtils:sharedFileUtils():addSearchPath("Script/ShopMall")	CCFileUtils:sharedFileUtils():addSearchPath("Script/BeginnersGuide")	-- 设置资源搜索路径	CCFileUtils:sharedFileUtils():addSearchPath("Config")		-- 配置	CCFileUtils:sharedFileUtils():addSearchPath("Sound")		-- 声音	CCFileUtils:sharedFileUtils():addSearchPath("Data")			-- xml数据表	CCFileUtils:sharedFileUtils():addSearchPath("Font")			-- 字体	CCFileUtils:sharedFileUtils():addSearchPath("Particle") 	-- 粒子	CCFileUtils:sharedFileUtils():addSearchPath("Layout")		-- 界面	CCFileUtils:sharedFileUtils():addSearchPath("Layout/GUI")	CCFileUtils:sharedFileUtils():addSearchPath("Picture")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/public")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/text")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/copyicon")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/copyres")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/guide")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/Icon")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/monster")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/skill_effect")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/cartoon")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/player/zs")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/player/qs")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/player/fs")	CCFileUtils:sharedFileUtils():addSearchPath("Picture/player/sm")end------------------------------------------------------------------------ 填充黑边local function fillBlackSide(rootNode)	local winSize = CCDirector:sharedDirector():getWinSize()	local winRatioWH = winSize.width/winSize.height	local frameSize = CCEGLView:sharedOpenGLView():getFrameSize()	local frameRatioWH = frameSize.width/frameSize.height	if frameRatioWH == winRatioWH or nil == type(FullScreenSprite) then		return	end	local function showSideSprite(fileName, sideWidth, sideHeight, anchorPoint, pos)		local sideSprite = FullScreenSprite:create(fileName)		local contentSize = sideSprite:getContentSize()		sideSprite:setScaleX(sideWidth/contentSize.width/(frameSize.width/winSize.width))		sideSprite:setScaleY(sideHeight/contentSize.height/(frameSize.height/winSize.height))		sideSprite:setAnchorPoint(anchorPoint)		sideSprite:setPosition(pos)		rootNode:addChild(sideSprite)	end	if frameRatioWH > winRatioWH then			-- 左右黑边		local sideWidth, sideHeight = (frameSize.width - winSize.width*(frameSize.height/winSize.height))/2, frameSize.height		showSideSprite("full_left_side.png", sideWidth, sideHeight, ccp(0, 0.5), ccp(0, winSize.height/2))		showSideSprite("full_right_side.png", sideWidth, sideHeight, ccp(1, 0.5), ccp(winSize.width, winSize.height/2))	elseif frameRatioWH < winRatioWH then		-- 上下黑边		local sideWidth, sideHeight = frameSize.width, (frameSize.height - winSize.height*(frameSize.width/winSize.width))/2		showSideSprite("full_top_side.png", sideWidth, sideHeight, ccp(0.5, 1), ccp(winSize.width/2, winSize.height))		showSideSprite("full_bottom_side.png", sideWidth, sideHeight, ccp(0.5, 0), ccp(winSize.width/2, 0))	endend------------------------------------------------------------------------ 预显示界面local function preShowUI(rootNode)	local winSize = CCDirector:sharedDirector():getWinSize()	-- 背景	local backgroundSprite = CCSprite:create("Register.png")	backgroundSprite:setAnchorPoint(ccp(0.5, 0.5))	backgroundSprite:setPosition(ccp(winSize.width/2, winSize.height/2))	rootNode:addChild(backgroundSprite)	-- 图片	local tipSprite = CCSprite:create("text_jiazai.png")	tipSprite:setPosition(ccp(winSize.width/2 - 40, 60))	rootNode:addChild(tipSprite)	-- 点	for i=1, 3 do		local pointSpite = CCSprite:create("text_dian.png")		pointSpite:setPosition(ccp(winSize.width/2 + 80 + (i-1)*25, 45))		rootNode:addChild(pointSpite)	endend------------------------------------------------------------------------ 每帧更新函数,有需要每帧执行的函数可以放在此模块内local function update(dt)	--RemoteDebug:update()	-- 定时器监听	UpdateTimer()	-- 监听网络消息	local totalRecv, curRecv = 0, NetSocket_update()	while curRecv > 0 do		-- 设置每帧接收字节数上限		if totalRecv >= 1024 then break end		curRecv = NetSocket_update()		totalRecv = totalRecv + curRecv	end	-- UIManager需要时时更新的监听	UILayerDateUpdate(dt)end------------------------------------------------------------------------ 初始化游戏local function initGame()	-- 包含lua文件	require "Require"	NetHelper.close()	UIManager.destroyAllUI()	g_uiRoot:removeAllChildrenWithCleanup(true)	-- 注册http相关	NetHttp.register(CONFIG["get_server_info"], "server")	NetHttp.register(CONFIG["account_server_url"], "regist")	NetHttp.register(CONFIG["account_server_url"], "login")	NetHttp.register(CONFIG["activity_server_url"], "cdkey")	-- 注册每帧调度函数	if nil == mUpdateId then		mUpdateId = CCDirector:sharedDirector():getScheduler():scheduleScriptFunc(update, 0, false)	end	-- 	UIManager.begin(LOGIN_OK, SHOW_LOGIN)	LuaAction.init()	TipView.create()end------------------------------------------------------------------------ 游戏主逻辑入口function Game_start()	-- step1:设置资源搜索路径	setSearchPath()	-- step2:设置屏幕设计分辨率尺寸	-- CCDirector:sharedDirector():setDisplayStats(true)								-- 调试信息	-- step3:开始运行场景	if nil == CCDirector:sharedDirector():getRunningScene() then		CCDirector:sharedDirector():runWithScene(g_rootNode)	else		CCDirector:sharedDirector():replaceScene(g_rootNode)	end	-- step4:预加载节点	require "worldConst"	if nil == g_rootNode:getChildByTag(50001) then		if tolua.isnull(g_sceneRoot) then			g_sceneRoot = CCLayer:create()			-- 战斗场景的父节点		end		g_rootNode:addChild(g_sceneRoot, g_Const_GameLayer.sceneLayer, 50001)	end	if nil == g_rootNode:getChildByTag(50002) then		if tolua.isnull(g_sceneUIRoot) then			g_sceneUIRoot = CCLayer:create()		-- 战斗UI场景父节点		end		g_rootNode:addChild(g_sceneUIRoot, g_Const_GameLayer.sceneLayer, 50002)	end	if nil == g_rootNode:getChildByTag(50003) then		if tolua.isnull(g_uiRoot) then			g_uiRoot = CCLayer:create()				-- 游戏界面的父节点		end		g_rootNode:addChild(g_uiRoot, g_Const_GameLayer.uiLayer, 50003)	end	-- step5:填充黑边	fillBlackSide(g_rootNode)	-- step6:预显示界面	preShowUI(g_uiRoot)	-- step7:延迟初始化游戏	local node = CCNode:create()	g_rootNode:addChild(node)	node:runAction(CCCallFuncN:create(function(sender)		node:removeFromParentAndCleanup(true)		initGame()	end))end------------------------------------------------------------------------ 程序进入后台调用function applicationDidEnterBackground()	Audio.pauseBgMsc()end------------------------------------------------------------------------ 程序进入前台调用function applicationWillEnterForeground()	Audio.playBgMscFromBackground()end----------------------------------------------------------------------