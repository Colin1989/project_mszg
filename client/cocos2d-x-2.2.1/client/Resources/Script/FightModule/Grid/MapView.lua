------------------------------------------------------------------------ 作者：lewis-- 日期：2013-04-11-- 描述：地图视图,包括背景,格子,迷雾遮罩----------------------------------------------------------------------MapView = {}local mRootView = nillocal mSceneInfo = nilfunction MapView.create(root)	mRootView = root	local id = GridMgr.getConfig("gmc_map_scene_id")	mSceneInfo = MapView.getSceneConfig(id)	MapView.createBackGround()	MapView.createFogMask()	MapView.createGrid()	GridTouchEvent.create(mRootView)		local batchNode = CCSpriteBatchNode:create("xx.png", 30)	mRootView:addChild(batchNode, 3)	GridMgr.setConfig("gmc_x_batch_node", batchNode)		batchNode = CCSpriteBatchNode:create("untouchable.png", 30)	mRootView:addChild(batchNode, 12)	GridMgr.setConfig("gmc_untouchable_batch_node", batchNode)		--特效层	local layer = CCLayer:create()	mRootView:addChild(layer, 11)	GridMgr.setConfig("gmc_effect_layer", layer)		--道具层	layer = CCLayer:create()	mRootView:addChild(layer, 10)	GridMgr.setConfig("gmc_item_layer", layer)		--技能背景特效层	layer = CCLayer:create()	mRootView:addChild(layer, 9)	EffectMgr.setConfig("emc_back_layer", layer)		--怪物层	layer = CCLayer:create()	mRootView:addChild(layer, 10)	RoleMgr.setConfig("rmc_monster_parent_layer", layer)	GridMgr.setConfig("gmc_monster_layer", layer)		--战斗信息提示层	layer = CCLayer:create()	mRootView:addChild(layer, 20)	GridMgr.setConfig("gmc_tips_layer", layer)		--怪物信息层	layer = CCLayer:create()	mRootView:addChild(layer, 14)	RoleMgr.setConfig("rmc_monster_info_parent_layer", layer)		--回合计数层	layer = CCLayer:create()	mRootView:addChild(layer)	BattleMgr.setConfig("bmc_round_timer_layer", layer)		--不可触摸提示层	layer = CCSpriteBatchNode:create("untouchable.png", 30)	mRootView:addChild(layer, 100)	GridMgr.setConfig("touch_disable_layer", layer)	    MapView.createTimer()end--创建场景可点击格子闪烁定时器function MapView.createTimer()    if GridMgr.getConfig("gmc_timmer") == nil then         GridMgr.setConfig("gmc_timmer", CreateTimer(8, -1,             function(tm)                local allGrid = GridMgr.getConfig("gmc_grid_table")                for k, v in pairs(allGrid) do                     --是否满足可以点击条件                    if v:isHighLightTips() == true and FightDateCache.getData("fd_copy_id") ~= FIRSTCOPYID then                         if v:getConfig("sprite_bg_mask") == nil then return end					    Lewis:spriteShaderEffect(v:getConfig("sprite_bg_mask"), "blank_grid.fsh", true)                        v:setConfig("isBright",true)                    end                  end         end , nil))    end     GridMgr.getConfig("gmc_timmer").start()end --场景配置信息local mSceneConfig = XmlTable_load("copy_bg_res_tplt.xml", "id")function MapView.getSceneConfig(id)	local res = XmlTable_getRow(mSceneConfig, id, true)	local row = {}	row.id 			= res.id		row.ground 		= res.ground		row.grid 		= res.grid	row.top 		= res.top	row.left1 		= res.left1	row.left2 		= res.left2	row.right1 		= res.right1	row.right2 		= res.right2	row.rate = CommonFunc_split(res.rate, ",")	return rowend--创建背景function MapView.createBackGround()	local visibleSize = CCDirector:sharedDirector():getVisibleSize()	local layer = CCLayer:create()	mRootView:addChild(layer)		--顶部背景	local topBgSprite = CCSprite:create("copyres/"..mSceneInfo.top)	local height = topBgSprite:boundingBox().size.height	topBgSprite:setPosition(ccp(0, visibleSize.height - height))	topBgSprite:setAnchorPoint(ccp(0,0))	layer:addChild(topBgSprite)	--地面	local tmxmapbg = CCTMXTiledMap:create("copyres/"..mSceneInfo.ground)	tmxmapbg:setPosition(ccp(visibleSize.width/2, visibleSize.height - height))	tmxmapbg:setAnchorPoint(ccp(0.5, 1))	layer:addChild(tmxmapbg)		local bgleftstr = "copyres/"..mSceneInfo.left1	local bgleft = CCSprite:create(bgleftstr)	bgleft:setPosition(ccp(0,visibleSize.height - height))	bgleft:setAnchorPoint(ccp(0,1))	layer:addChild(bgleft, 10)		if mSceneInfo.left2 ~= "0" then 		local bgleft2str = "copyres/"..mSceneInfo.left2		local bgleft2 = CCSprite:create("copyres/"..mSceneInfo.left2)		bgleft2:setPosition(ccp(0,visibleSize.height - height))		bgleft2:setAnchorPoint(ccp(0,1))		layer:addChild(bgleft2, 10)	end	local bgrightstr = "copyres/"..mSceneInfo.right1	local bgright = CCSprite:create(bgrightstr)	bgright:setPosition(ccp(visibleSize.width,visibleSize.height - height))	bgright:setAnchorPoint(ccp(1,1))	layer:addChild(bgright, 10)	if mSceneInfo.right2 ~= "0" then 		local bgright2str = "copyres/"..mSceneInfo.right2		local bgright2 = CCSprite:create(bgright2str)		bgright2:setPosition(ccp(visibleSize.width, visibleSize.height - height))		bgright2:setAnchorPoint(ccp(1,1))		layer:addChild(bgright2, 10)	endend--迷雾遮罩层function MapView.createFogMask()	local width 	= GridMgr.getConfig("gmc_map_width")	local height 	= GridMgr.getConfig("gmc_map_height")	local gw 	= GridMgr.getConfig("gmc_grid_width")	local gh 	= GridMgr.getConfig("gmc_grid_height")		--创建遮罩	local visibleSize = CCDirector:sharedDirector():getVisibleSize()	local layer = CCTMXTiledMap:create("gamemask.tmx")	layer:setPosition(ccp(visibleSize.width / 2, visibleSize.height / 2))	layer:setAnchorPoint(ccp(0.5, 0.5))	mRootView:addChild(layer, 12)		local rect		= layer:boundingBox()	local startPos = ccp(rect.origin.x, rect.origin.y)	--设置地图区域大小	GridMgr.setConfig("gmc_map_rect", rect)		--绑定数据	local tmxlayer = layer:layerNamed("layer1")	for y = 1, height do		for x = 1, width do			local sprite = tmxlayer:tileAt(ccp(x - 1, y - 1))			local px, py = sprite:getPosition()			local grid = GridMgr.getGridByCoord(x, y)			grid:setConfig("sprite_fog_mask", sprite)			grid:setConfig("position", ccp(startPos.x + px + gw / 2, startPos.y + py + gh / 2))						--grid:setPosition(ccp(startPos.x + px + gw / 2, startPos.y + py + gh / 2))			--grid:setMaskSprite(sprite)		end	end	end-- 从不定长的概率表local function getRandomGirdIndex() 	local seed = math.random(1, 100)		local rate = 0	for k,v in pairs(mSceneInfo.rate) do		rate = rate + tonumber(v) 		if seed <= rate then 			return k		end	endend--格子层function MapView.createGrid()	local width 	= GridMgr.getConfig("gmc_map_width")	local height 	= GridMgr.getConfig("gmc_map_height")	local gw 		= GridMgr.getConfig("gmc_grid_width")	local gh 		= GridMgr.getConfig("gmc_grid_height")	local rect		= GridMgr.getConfig("gmc_map_rect")		local startPos = ccp(rect.origin.x, rect.origin.y)		--local batchNode = CCSpriteBatchNode:create("copyres/"..mSceneInfo.grid, 30)	  --动态格子层     local batchNode = CCLayer:create()	                                            --动态格子层 	mRootView:addChild(batchNode, 1)		batchNode:setPosition(0, 0)	--local texture = batchNode:getTexture()    startPos.y = startPos.y - 67	for y = 1, height do		for x = 1, width do			local index = getRandomGirdIndex()					--local sprite = CCSprite:createWithTexture(texture, CCRectMake(gw * (index - 1), 0, gw, 172))            local sprite = CCSprite:create("copyres/"..mSceneInfo.grid, CCRectMake(gw * (index - 1), 0, gw, 172))            			sprite:setPosition(startPos.x + gw * (x - 1),	startPos.y + gh * (y - 1))			sprite:setAnchorPoint(ccp(0, 0))			batchNode:addChild(sprite, height - y)						local grid = GridMgr.getGridByCoord(x, height - y + 1)			grid:setConfig("sprite_bg_mask", sprite)		end	endend