------------------------------------------------------------------------ 作者：lewis-- 日期：2013-04-11-- 描述：道具格子,包括陷阱，掉落物品等----------------------------------------------------------------------GridItem = class(Grid)--事件表local mEventConfig = XmlTable_load("event_tplt.xml", "id")local function getGridEventByID(id)	if id == 0 then		return nil	end	local row = XmlTable_getRow(mEventConfig, id, true)	local config = {}	config.id = row.id		config.type = row.type + 0	config.skill = row.skill + 0	config.trigger_effect_id = row.trigger_effect_id or 0	config.trigger_effect_id = config.trigger_effect_id + 0	config.argsStr = row.params		config.number = tonumber(row.number)	config.icon = row.icon	config.name = row.name	return configend--构造function GridItem:ctor()	self.mEventId 	= 0		--事件id	self.mEventType = 0		--事件类型	self.mSkillId 	= 0		--调用的技能	self.mNumber  	= 0		--金币数量	self.mEventName = ""	--事件名	self.mEffectId	= 0		--打开时播放的id	self.mTotemArgs = ""	--图腾参数	self.mSpriteDropOut = nilend--绑定数据function GridItem:bindData(data)	local eventId = data	--eventId = 6001	self.mEventId = eventId	local config = getGridEventByID(eventId)	if config == nil then 		return	end	self.mEventType = config.type	self.mEventId 	= eventId	self.mSkillId 	= config.skill	self.mNumber  	= config.number	self.mEventName = config.name	self.mEffectId	= config.trigger_effect_id	self.mTotemArgs = config.argsStr	if eventId == 7 then	--图腾		FightResLoader.preloadMonsterRes(self.mSkillId)	elseif self.mSkillId ~= 0 then		FightResLoader.preloadSkillRes(self.mSkillId)	end		--开格子动画	if self.mEffectId ~= 0 then		FightResLoader.preloadSkillEffectRes(self.mEffectId)	endend--外部触发事件function GridItem:onEvent()	if self:getConfig("is_invalid") then 		return 	end	if self.mEventType == 1 then		self:goldEvent()	elseif self.mEventType == 2 then		self:bloodBottleEvent()	elseif self.mEventType == 3 then		self:trapEvent()	elseif self.mEventType == 6 then		self:bombEvent()	elseif self.mEventType == 7 then		self:totemEvent()	endend---------------------------------------------------------------------------------------------------------------血瓶--------------------------------------------------------------------------------------------------------------function GridItem:bloodBottleEvent()	--打开格子	if self:getConfig("is_opened") == false then		--周边有怪物或被迷雾遮罩		if self:isCanOpened() == false then 			GridMgr.setConfig("gmc_touch_effect", false)			return 		end		self:triggerNextRound()		self:openGrid()		self:openFogMask()		self:effectRemoveBg()		self:setConfig("event_name", "blood_bottle")		--显示血瓶		self:showDropOut("item5.png")		return	end	if self.mSpriteDropOut ~= nil then		local effect = EffectBloodBottle.new()		effect:init(self.mSpriteDropOut)		effect:play()		self.mSpriteDropOut = nil	end	--拾取	SoundDispath.pickupItem("blood_bottle")	local pos = self:getPosition()	pos.y = pos.y + 50	BattleMgr.itemSkillForPlayer(pos, self.mSkillId)	self:setConfig("is_invalid", true)	GuideEvent.pickupBloodBottle()	self:setConfig("event_name", "none")end---------------------------------------------------------------------------------------------------------------金币--------------------------------------------------------------------------------------------------------------function GridItem:goldEvent()	--打开格子	if self:getConfig("is_opened") == false then		--周边有怪物或被迷雾遮罩		if self:isCanOpened() == false then 			GridMgr.setConfig("gmc_touch_effect", false)			return 		end		self:triggerNextRound()		self:openGrid()		self:openFogMask()		self:effectRemoveBg()		self:setConfig("event_name", "coins")		--显示金币		self:showDropOut("item2.png")		return	end	--拾取	if self.mSpriteDropOut ~= nil then		SoundDispath.pickupItem("coins")		local effect = EffectGainCoins.new()		effect:init(self.mSpriteDropOut, self.mNumber, self:getPosition())		effect:play()		self.mSpriteDropOut = nil		GuideEvent.pickupGold()		self:setConfig("event_name", "none")				FightDateCache.gainCoins(self.mNumber)	endend---------------------------------------------------------------------------------------------------------------陷阱--------------------------------------------------------------------------------------------------------------function GridItem:trapEvent()	--打开格子	if self:isCanOpened() == false then 		GridMgr.setConfig("gmc_touch_effect", false)		return 	end	self:triggerNextRound()	self:openGrid()	self:openFogMask()	self:effectTrapTips()		--播放陷阱特效	if self.mEffectId ~= 0 then		local pos = self:getPosition()		pos.y = pos.y + 50		local effect = EffectAnimate.new()		effect:init(pos, self.mEffectId)		effect:play()	end	SoundDispath.touchTrap(0)	local pos = self:getPosition()	pos.y = pos.y + 50	BattleMgr.itemTrap(pos, self.mSkillId)	self:setConfig("is_invalid", true)end-------------------------------------------------------------------------------------------------------------爆炸格子------------------------------------------------------------------------------------------------------------function GridItem:bombEvent()	--打开格子	if self:isCanOpened() == false then 		GridMgr.setConfig("gmc_touch_effect", false)		return 	end	self:triggerNextRound()	self:openGrid()	self:openFogMask()	self:effectTrapTips()	self:setConfig("is_invalid", true)	local targets = GridMgr.getBombGridTargets(self.mNumber)	local effect = EffectBombGrid.new()	effect:init(self:getPosition(), targets)	effect:play()end-----------------------------------------------------------------------------------------------------------------图腾------------------------------------------------------------------------------------------------------------function GridItem:totemEvent()	--打开格子	if self:isCanOpened() == false then 		GridMgr.setConfig("gmc_touch_effect", false)		return 	end	local pos = self:getPosition()	pos.y = pos.y - 50	RoleMgr.createTotem(self:getConfig("grid_id"), pos, self.mSkillId, self.mTotemArgs)	self:triggerNextRound()	self:openGrid()	self:openFogMask()	self:effectRemoveBg()	self:setConfig("is_invalid", true)endfunction GridItem:summonItem()    local pos = self:getPosition()	pos.y = pos.y - 50    if self.mEventType == 1 then		self:setConfig("event_name", "coins")		self:showDropOut("item2.png")	elseif self.mEventType == 2 then		self:setConfig("event_name", "blood_bottle")		self:showDropOut("item5.png")	elseif self.mEventType == 3 then	elseif self.mEventType == 6 then	elseif self.mEventType == 7 then		RoleMgr.createTotem(self:getConfig("grid_id"), pos, self.mSkillId, self.mTotemArgs)	    self:openGrid()	    self:openFogMask()	    self:effectRemoveBg()	    self:setConfig("is_invalid", true)	endend--移除自身local function removeSelf(sender)	sender:removeFromParentAndCleanup(true)end--显示掉落的物品function GridItem:showDropOut(filename)	local pos = self:getPosition()	pos.y = pos.y + 50	local layer = GridMgr.getConfig("gmc_item_layer")	local sprite = CCSprite:create(filename)	layer:addChild(sprite)	sprite:setPosition(pos)	self.mSpriteDropOut = sprite	GridMgr.actionDropDown(sprite, 50)end--显示陷阱提示function GridItem:effectTrapTips()	local pos = self:getPosition()	local layer = GridMgr.getConfig("gmc_item_layer")		local sprite = CCSprite:create("grid_effect_bomb.png")	layer:addChild(sprite)	sprite:setAnchorPoint(ccp(0.5, 0.5))	sprite:setPosition(pos.x, pos.y + 30)		local arr = CCArray:create()    arr:addObject(CCSpawn:createWithTwoActions(CCScaleTo:create(0.15, 1.0), CCFadeIn:create(0.1)))	arr:addObject(CCScaleTo:create(0.3, 0.9))	arr:addObject(CCDelayTime:create(0.8))	arr:addObject(CCFadeOut:create(0.3))	arr:addObject(CCCallFuncN:create(removeSelf))	sprite:runAction(CCSequence:create(arr))end