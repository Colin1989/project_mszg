------------------------------------------------------------------------ 作者：lewis-- 日期：2013-4-4-- 描述：道具产生的技能魔法攻击----------------------------------------------------------------------ItemSkill = {}--对战function ItemSkill.fight(casterPos, target, id, level, timer,atk)--施法者,指向性目标,技能id,技能等级,怪物攻击力    --援军不帮档伤害	local groupId = target:getConfig("role_group_id")--组别id,0是玩家,1是怪物,2友军	if groupId == 2 then		target = RoleMgr.getConfig("rmc_player_object")	end		local targetTB = {}	table.insert(targetTB, target)    local monsterAtk = atk or 0	local round = BattleMgr.getConfig("bmc_current_round")	local dp, hp = SkillMgr.calDamageValue(id, level, monsterAtk)		--无施法动作		local targetPosTB = {}	for key, value in pairs(targetTB) do		table.insert(targetPosTB, value:getMiddlePos())	end		if timer == nil then		timer = round:getLastTime()	end	--技能特效	local step = StepSkillEffect.new()	step:init(casterPos, targetPosTB, id)	step:setTimer(timer)	round:add(step)	local durationTB = step:getDuration()	--返回的是时间表		local base = SkillConfig.getSkillBaseInfo(id)	--对目标数值计算	for key, value in pairs(targetTB) do		local step = StepAfterItemSkill.new()		step:setTimer(timer + durationTB[key])		round:add(step)		--伤害数值重新计算,算暴击与闪避等效果		local damage = ItemSkill.numCalOfAttack(value, dp)		damage:setData("position", value:getTopPos())				--伤害转移		BattleMgr.defenderBearDamage(value, damage, timer)		value:bearDamage(damage:getData("damage"))			--buff计算		local bBuff = false		--几率计算		local bActiveBuff = nil         bActiveBuff = SkillMgr.isOnBuff(base.quality, level, base.target_buff_rate,value)		local config = SkillConfig.getSkillBuffInfo(base.target_buff_id,base.quality,level)		if damage:getData("type") ~= "miss" and config ~= nil and bActiveBuff then 			--local buff = value:getDataInfo("buff")			--buff:active(base.target_buff_id, base.quality, level)			--buff:afterActiveBuff()            BuffMgr.createFactory(base.target_buff_id, base.quality, level,target,nil)			bBuff = true		end		step:init(value, damage, id, level, bBuff)	endendlocal mAttackAttribute = DataAttribute.new()--伤害数值计算function ItemSkill.numCalOfAttack(defender, dp)	local attribute1 = mAttackAttribute	local attribute2 = defender.mData.mAttribute	local result = attribute1:attack(attribute2)		--状态	local defenderStatus = defender.mData.mStatus	--被击者,隐身中,强制设成miss	if defenderStatus:getStatus("status_stealth") then		if dp < 0 then			if defender:isCommonAttackValid() then				result = "miss"			end		end	end    if dp > 0 and result == "miss" then        result = "hit"    end		if result == "miss" then		dp = 0	elseif result == "crit" then		local rate = BattleMgr.getConfig("bmc_crit_rate")		dp = math.ceil(dp * rate)	end			--伤害加深计算	if result ~= "miss" and dp < 0 then		local rate = defenderStatus:getStatus("status_amplify_damage")		dp = dp + (math.ceil(dp * rate))	end       --伤害减少计算	if result ~= "miss" and dp < 0  then		local value = defenderStatus:getStatus("status_damage_reduce_value")		dp = dp + value        if dp > -1 then dp = -1 end 	end    		--魔法伤害减免计算	if result ~= "miss" and dp < 0 then		local rate = defenderStatus:getStatus("status_magic_immune_rate")		dp = dp - (math.ceil(dp * rate))	end		local damage = Damage.new()	damage:setData("damage", dp)	damage:setData("type", result)	return damageend