------------------------------------------------------------------------ 作者：lewis-- 日期：2013-4-4-- 描述：伤害----------------------------------------------------------------------Damage = class()--构造function Damage:ctor()	self.mData 	= {}	self.mData["damage"]	= 0					--伤害数值	self.mData["type"]		= "hit"				--伤害类别	self.mData["position"]	= ccp(360, 540)		--特效显示位置    self.mData["desPos"] = nil                  --转移伤害最终位置	self.mData["effect_id"]	= 0					--播放的技能特效	self.mData["behavior"]	= "none"			--行为提示end--获得数据function Damage:getData(name)	return self.mData[name]end--设置数据function Damage:setData(name, value)	self.mData[name] = valueend--移除自身local function removeSelf(sender)	sender:removeFromParentAndCleanup(true)endlocal mDelay = 1.15local function playAction(node)	local act1 = CCSequence:createWithTwoActions(CCDelayTime:create(mDelay * 0.75), CCFadeTo:create(mDelay * 0.25, 64))	node:runAction(CCSpawn:createWithTwoActions(CCMoveBy:create(mDelay, CCPointMake(0, 40)), act1))end--显示效果function Damage:play()	self:playNumerical()	local effectId = self:getData("effect_id")    --嘲讽效果	if effectId ~= 0 then		local effect = EffectAnimate.new()		effect:init(self:getData("position"), effectId)		effect:play()        local desPos = self:getData("desPos")        --嘲讽轨迹        if desPos ~= nil then             local speed = EffectMgr.getConfig("emc_ballistic_speed") * 0.5
	        local Block_ball = EffectBallistic.new()
	        Block_ball:init(self:getData("position"), self:getData("desPos"), 117, 0, 49)
	        Block_ball:setSpeed(speed)
	        --self.mBallistic:setCallback(openDoorCB, nil)
	        Block_ball:play()        end 	end    if self:getData("behavior") ~= "none" then       local behavior = BehaviorInfo.new()       behavior:init(self:getData("behavior"), self:getData("position"))       behavior:play()     endend-----------------------------------------------------------------------------------------------------------数值显示--------------------------------------------------------------------------------------------------------------function Damage:playNumerical()	if self.mData["damage"] == 0 then		return	end		--回血不显示暴击效果	if self.mData["damage"] > 0 then		self.mData["type"] = "hit"	end		local scale1 = 1.8	local scale2 = 1.5	local node, offx = self:numericalValue()				if self.mData["type"] == "crit" then		FightAnimation_Crit(g_sceneRoot)  -- 暴击动画		scale1 = 2.8		scale2 = 1.5	end		local pos = self.mData["position"]	local layer = BattleMgr.getConfig("bmc_damage_layer")	layer:addChild(node)	node:setPosition(ccp(pos.x + offx, pos.y))	node:setAnchorPoint(ccp(0.0, 0.0))		local act1 = CCEaseBackInOut:create(CCScaleBy:create(0.15, scale1))	local act2 = CCEaseBackInOut:create(CCScaleBy:create(0.05, 1 / scale2))	node:runAction(CCSequence:createWithTwoActions(act1, act2))	local act3 = CCSequence:createWithTwoActions(CCDelayTime:create(mDelay), CCCallFuncN:create(removeSelf))	node:runAction(act3)end--创建数值的视图function Damage:numericalValue()	local layer = CCLayer:create()	local label = nil	local symbol = nil	local preSprite = nil	local offx = 0	local valueStr = string.format("%d", math.abs(self.mData["damage"]))	if self.mData["type"] == "crit" then		offx = 80		preSprite = CCSprite:create("fight_effect_crit.png")		label = CCLabelAtlas:create(valueStr, "num_yellow.png", 24, 32, 48)		symbol = CCSprite:create("num_symbol.png", CCRectMake(24 * 1, 0, 24, 32))	else		if self.mData["damage"] > 0 then			offx = 55			preSprite = CCSprite:create("fight_effect_life.png")			label = CCLabelAtlas:create(valueStr, "num_green.png", 24, 32, 48)			symbol = CCSprite:create("num_symbol.png", CCRectMake(24 * 6, 0, 24, 32))		else			label = CCLabelAtlas:create(valueStr, "num_red.png", 24, 32, 48)			symbol = CCSprite:create("num_symbol.png", CCRectMake(24 * 2, 0, 24, 32))		end	end		layer:addChild(label)	label:setAnchorPoint(ccp(0.0, 0.5))	label:setPosition(ccp(0, 0))	playAction(label)		layer:addChild(symbol)	symbol:setPosition(ccp(-15, 0))	playAction(symbol)		if preSprite ~= nil then		layer:addChild(preSprite)		preSprite:setScale(0.5)		preSprite:setPosition(ccp(-55, 0))		playAction(preSprite)	end	return layer, offxend