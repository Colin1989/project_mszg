------------------------------------------------------------------------ 作者：lewis-- 日期：2013-4-4-- 描述：技能特效完后的受击动作----------------------------------------------------------------------StepAfterRoleSkill = class(BattleStep)--构造function StepAfterRoleSkill:ctor()    self.mCaster    = nil    self.mHealth    = nil	self.mTarget 	= nil		--受击的角色	self.mDamage	= nil		--伤害	self.mSkillId	= 0	self.mLevel		= 0	self.mbBuff		= false	self.mName		= "after_skill"end--初始化function StepAfterRoleSkill:init(caster, health, target, damage, id, level, bBuff)    self.mCaster    = caster    self.mHealth    = health	self.mTarget	= target	self.mDamage 	= damage	self.mSkillId	= id	self.mLevel		= level	self.mbBuff		= bBuff	self.mDuration = self.mTarget:getDuration("attack")end--执行对应的操作function StepAfterRoleSkill:excute()	local dp = self.mDamage:getData("damage")    --print("what the fuck 2",dp,self.mDamage:getData("type"))    if self.mDamage:getData("type") == "miss" and dp <= 0 then       self.mTarget:changeBehaviorState("dodge")	   local behavior = BehaviorInfo.new()	   behavior:init("dodge", self.mTarget:getBottomPos())	   behavior:play()    end          	if dp < 0 then	    self.mTarget:changeAnimateState("hit")    end                	self.mDamage:play()	--已上buff	if self.mbBuff then		--对目标上buff		self.mTarget:updateInfoView("buff")		self.mTarget:updateInfoView("skill")		self.mTarget:changeShader()		self.mTarget:changePortraits()	end	self.mTarget:settleDamage(dp)    local dp = self.mHealth:getData("damage")    --魔法免疫    local magic_immune_rate  = self.mTarget:getDataInfo("status"):getStatus("status_magic_immune_rate")    if  magic_immune_rate > 0 and dp < 0 and self.mTarget:isCommonAttackValid()  then        local behavior = BehaviorInfo.new()		behavior:init("magic_immunity", self.mTarget:getBottomPos())		behavior:play()        local effect = EffectAnimate.new()		effect:init(self.mTarget:getMiddlePos(), 118)		effect:play()    end     --魔法反伤    if dp ~= 0 then        self.mHealth:play()		self.mCaster:settleDamage(dp)             if dp < 0 then			local behavior = BehaviorInfo.new()			behavior:init("rebound", self.mTarget:getMiddlePos())			behavior:play()            local effect = EffectDamageRebound.new()            effect:init(self.mTarget:getBottomPos(),self.mCaster:getBottomPos())            effect:play()            self.mCaster:changeAnimateState("hit")		end         endend