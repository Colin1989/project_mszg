------------------------------------------------------------------------ 作者：lewis-- 日期：2013-05-22-- 描述：漫画----------------------------------------------------------------------CartoonScene = {}local function localPrint(...)	if true then return end	lewisPrint("CartoonScene", ...)endlocal mParentLayer = nillocal mCurSceneIdx = 0local mPartTB = {}--开始播放function CartoonScene.play()	mParentLayer = nil	mParentLayer = CCLayer:create()	g_rootNode:addChild(mParentLayer, 100000)	mCurSceneIdx = 0	CartoonScene.nextScene()	end--下一场景function CartoonScene.nextScene()	mCurSceneIdx = mCurSceneIdx + 1	if mCurSceneIdx > #mPartTB then		return	end	mPartTB[mCurSceneIdx]()end--------------------------------------action+++++++++++++++++++++++++++++++function CartoonScene.createSprite(filename, x, y)	local sprite = CCSprite:create(filename)	mParentLayer:addChild(sprite)	sprite:setPosition(ccp(x, y))	return spriteendfunction CartoonScene.stop(callback)	mParentLayer:removeFromParentAndCleanup(true)	--CCTextureCache:sharedTextureCache():removeUnusedTextures()		if type(callback) == "function" then 		callback()	end 	end function CartoonScene.moveBy(sprite, duration, offx, offy, callback)	sprite:setVisible(true)	local sx, sy = sprite:getPosition()	sprite:setPosition(ccp(sx - offx, sy - offy))	local arr = CCArray:create()		local moveBy = CCEaseBackOut:create(CCMoveBy:create(duration, ccp(offx, offy)))	local fadeOut = CCFadeIn:create(duration)	local action = CCSpawn:createWithTwoActions(moveBy,fadeOut)		arr:addObject(action)	arr:addObject(CCCallFuncN:create(callback))	sprite:runAction(CCSequence:create(arr))endfunction CartoonScene.fadeIn(sprite, duration, callback)	sprite:setVisible(true)	local arr = CCArray:create()    arr:addObject(CCFadeIn:create(duration))	arr:addObject(CCCallFuncN:create(callback))	sprite:runAction(CCSequence:create(arr))end--第一部分function CartoonScene.partOne()	local function p1ActDone_1(sender)		CartoonScene.nextScene()	end	local sprite = CartoonScene.createSprite("cartoon1_1.png", 110, 960 - 160)	CartoonScene.moveBy(sprite, 0.7, 200, 0, p1ActDone_1)endfunction CartoonScene.partTwo()	local function p2ActDone_1(sender)		CartoonScene.nextScene()	end	local sprite = CartoonScene.createSprite("cartoon2_1.png", 640 - 210, 960 - 160)	CartoonScene.moveBy(sprite, 0.8, 0, -200, p2ActDone_1)endfunction runDelayFunc(_array,delayTime,stepFunc)	_array:addObject(CCCallFuncN:create(stepFunc))	_array:addObject(CCDelayTime:create(delayTime))end function DelayCallFunc(_array,delayTime,stepFunc)	_array:addObject(CCDelayTime:create(delayTime))	_array:addObject(CCCallFuncN:create(stepFunc))end function CartoonScene.partThree()	local ftps = 0.2	local TextureCache = CCTextureCache:sharedTextureCache()	local arr2 = CCArray:create()	local bg1 = CartoonScene.createSprite("cartoon3_2.png", 320, 480 + 36)	bg1:setVisible(true)		local player1 = CartoonScene.createSprite("cartoon3_1.png", 320, 480 + 36 - 9)	player1:setVisible(true)	arr2:addObject(CCFadeIn:create(0.5))		runDelayFunc(arr2,0.2,function(sender)		tolua.cast(sender,"CCSprite")		sender:setOpacity(128)	end)	--[[	runDelayFunc(arr2,0.3,function(sender)		tolua.cast(sender,"CCSprite")		sender:setOpacity(128)	end)	]]--	local effect1 = CartoonScene.createSprite("cartoon3_4.png", 320, 480 + 36 )	effect1:setVisible(false)		--猪	local spritePig = CartoonScene.createSprite("four_pig.png", 207, 64 + 480 + 36 - 126)	--spritePig:setVisible(false)		runDelayFunc(arr2,ftps,function(sender)		tolua.cast(sender,"CCSprite")		sender:setTexture(TextureCache:addImage("cartoon3_6.png"))		bg1:setTexture(TextureCache:addImage("cartoon3_7.png"))		spritePig:setVisible(true)		--spritePig:runAction(CCRotateBy:create(0.2, -20));	end)			runDelayFunc(arr2,ftps- 0.2,function(sender)	--法师放技能		effect1:setVisible(true)		--spritePig:setRotation(-20)	end)		runDelayFunc(arr2,ftps,function(sender)	--猪变色		sender:setOpacity(255)		spritePig:setTexture(TextureCache:addImage("cartoon3_3.png"))	end)			runDelayFunc(arr2,0.1,function(sender)			Lewis:spriteShaderEffect(effect1, "four_red_white.fsh", true)	end)		runDelayFunc(arr2,0.1,function(sender)			Lewis:spriteShaderEffect(effect1, "four_allwhite.fsh", true)	end)		runDelayFunc(arr2,0.1,function(sender)			Lewis:spriteShaderEffect(effect1, "four_black_white.fsh", true)	end)		runDelayFunc(arr2,0.1,function(sender)			Lewis:spriteShaderEffect(effect1, "four_red_white.fsh", true)	end)		runDelayFunc(arr2,0.1,function(sender)			player1:setVisible(false)		Lewis:spriteShaderEffect(bg1, "four_allwhite.fsh", true)		Lewis:spriteShaderEffect(effect1, "four_light_white.fsh", true)	end)		runDelayFunc(arr2,0.1,function(sender)			player1:setVisible(true)		Lewis:spriteShaderEffect(bg1, "null", false)		Lewis:spriteShaderEffect(effect1, "four_light_half_white.fsh", true)	end)		runDelayFunc(arr2,0.1,function(sender)			Lewis:spriteShaderEffect(effect1, "four_light_half_white.fsh", false)	end)			---缺移动	runDelayFunc(arr2,0.1,function(sender)			Lewis:spriteShaderEffect(effect1, "four_light_half_white.fsh", false)	end)		arr2:addObject(CCCallFuncN:create( CartoonScene.nextScene ))	player1:runAction(CCSequence:create(arr2))	endfunction CartoonScene.partFour()	local delat = -80	local target = 111000 	local colorLayer = CCLayerColor:create(ccc4(180,0,0,155),640 ,204);	--local colorLayer = CCLayerColor:create(ccc4(250,250,250,155),720 ,226);	colorLayer:setPosition(ccp(0, 350 - 204/2+delat))	mParentLayer:addChild(colorLayer,10)	colorLayer:setVisible(false)	local blockTime = 0.05		local bg1 = CartoonScene.createSprite("cartoon5_4.png", 320, 350 +delat)--底图	local arr5 = CCArray:create()	DelayCallFunc(arr5,0.6,function(sender)		tolua.cast(sender,"CCSprite")		sender:setOpacity(128)	end)		DelayCallFunc(arr5,blockTime,function(sender)		colorLayer:setVisible(true)	end)		DelayCallFunc(arr5,blockTime,function(sender)		colorLayer:setColor(ccc3(180,0,0))	end)		DelayCallFunc(arr5,blockTime,function(sender)		colorLayer:setColor(ccc3(250,250,250))	end)		DelayCallFunc(arr5,blockTime,function(sender)		colorLayer:setColor(ccc3(180,0,0))	end)		DelayCallFunc(arr5,blockTime,function(sender)		colorLayer:setVisible(false)	end)		DelayCallFunc(arr5,0.5,function(sender)		tolua.cast(sender,"CCSprite")		sender:setOpacity(255)	end)		arr5:addObject(CCDelayTime:create(0.75))	arr5:addObject(CCFadeOut:create(0.5))		arr5:addObject(CCCallFuncN:create(function(sender)		mParentLayer:removeChild(bg1,true)		mParentLayer:removeChild(monster1,true)		mParentLayer:removeChild(monster2,true)				CartoonScene.nextScene()	end))		bg1:runAction(CCSequence:create(arr5))	--闪电	local effect1 = CartoonScene.createSprite("cartoon5_3.png", 320, 350+delat)	effect1:setVisible(false)		local arr4 = CCArray:create()	DelayCallFunc(arr4,0.6,function(sender)		sender:setVisible(true)	end)	arr4:addObject(CCScaleBy:create(blockTime, 1.0, 2.0));	arr4:addObject(CCScaleBy:create(blockTime, 1.0, 0.5));	arr4:addObject(CCScaleBy:create(blockTime, 1.0, 2.0));	arr4:addObject(CCScaleBy:create(blockTime, 1.0, 0.2));	arr4:addObject(CCScaleBy:create(blockTime, 1.0, 0.04));		DelayCallFunc(arr4,0.1,function(sender)		sender:setVisible(false)	end)	effect1:runAction(CCSequence:create(arr4))		--小猪	local monster1 = CartoonScene.createSprite("cartoon5_1.png", 320, 350+delat)	local arr2 = CCArray:create()	DelayCallFunc(arr2,0.7,function(sender)		sender:setVisible(false)	end)		DelayCallFunc(arr2,0.8,function(sender)		sender:setVisible(true)	end)		DelayCallFunc(arr2,0.1,function(sender)		tolua.cast(sender,"CCSprite")		sender:setOpacity(128)	end)	arr2:addObject(CCSpawn:createWithTwoActions(CCMoveBy:create(0.5, ccp(180, 0)),	CCFadeOut:create(0.5)))	monster1:runAction(CCSequence:create(arr2))		--野猪	local monster2 = CartoonScene.createSprite("cartoon5_2.png", 320, 350+delat)	monster2:setVisible(false)	local arr3 = CCArray:create()	DelayCallFunc(arr3,0.6,function(sender)		tolua.cast(sender,"CCSprite")		sender:setOpacity(128)		sender:setVisible(true)	end)	DelayCallFunc(arr3,0.1,function(sender)		tolua.cast(sender,"CCSprite")		sender:setOpacity(255)	end)	DelayCallFunc(arr3,0.9,function(sender)		tolua.cast(sender,"CCSprite")		sender:setOpacity(255)	end)		arr3:addObject(CCSpawn:createWithTwoActions(CCMoveBy:create(0.5, ccp(-180, 0)),	CCFadeOut:create(0.5)))	monster2:runAction(CCSequence:create(arr3))endlocal function seekRecursive(pArray) 	for i = 1,pArray:count() do		--localPrint("count",pArray:count(),"index",i-1)        local obj = tolua.cast(pArray:objectAtIndex(i - 1),"CCSprite")		--tolua.cast(obj,"CCSprite")		if obj ~= nil then 			obj:runAction(CCFadeOut:create(0.5))			if obj:getChildren() ~= nil and obj:getChildren():count() > 0 then 				return seekRecursive(obj:getChildren()) 			end		end 	end end function CartoonScene.partFive()	local function p5ActDone(sender)		--CartoonScene.nextScene()	end		local bg1 = CartoonScene.createSprite("cartoon4_6.png", 320, 198)	bg1:setOpacity(0)	bg1:setScale(0.8)		local arr = CCArray:create()	arr:addObject(CCSpawn:createWithTwoActions(CCFadeIn:create(0.8),	CCScaleTo:create(0.8,1.0)))	bg1:runAction(CCSequence:create(arr))		--法师 	local fs = CCSprite:create("cartoon4_5.png")				fs:setPosition(ccp(302,265))	bg1:addChild(fs)		local arr2 = CCArray:create()	arr2:addObject(CCDelayTime:create(0.1))	arr2:addObject(CCMoveBy:create(2.1, ccp(0, 27)))	DelayCallFunc(arr2,0.1,function(sender)			local pArray = mParentLayer:getChildren()		seekRecursive(pArray)	end)		DelayCallFunc(arr2,0.6,function(sender)			CartoonScene.stop(fourFrames.stop)	end)	fs:runAction(CCSequence:create(arr2))		--肥猪	local fat_pig = CCSprite:create("cartoon4_1.png")	fat_pig:setPosition(ccp(385,180))	fat_pig:setScale(0.6)	bg1:addChild(fat_pig)		local arr3 = CCArray:create()		arr3:addObject(CCRotateBy:create(2.0, 10))	arr3:addObject(CCScaleTo:create(2.0,0.9))	arr3:addObject(CCMoveBy:create(2.0, ccp(45,0)))			fat_pig:runAction(CCSpawn:create(arr3))		endmPartTB[1] = CartoonScene.partOnemPartTB[2] = CartoonScene.partTwomPartTB[3] = CartoonScene.partThreemPartTB[4] = CartoonScene.partFourmPartTB[5] = CartoonScene.partFive