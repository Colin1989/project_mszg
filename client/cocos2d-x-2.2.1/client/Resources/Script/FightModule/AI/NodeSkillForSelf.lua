------------------------------------------------------------------------ 作者：lewis-- 日期：2013-3-31-- 描述：对自身使用技能----------------------------------------------------------------------NodeSkillForSelf = class(NodeUseSkill)--构造function NodeSkillForSelf:ctor()end--计算权值function NodeSkillForSelf:calc()	local player = RoleMgr.getConfig("rmc_player_object")	local id = self.mSkillId	local level = player.mData.mSkill:getLevel(id)	local attribute = player.mData.mAttribute	local atk = attribute:getByName("atk")	local life = attribute:getByName("life")	local maxlife = attribute:getMaxAttrWithName("life")	local dp, hp = SkillMgr.calDamageValue(id, level, atk)	local health = dp + hp	local lost = maxlife - life	local buffStr = nil    --召唤技能    local base = SkillConfig.getSkillBaseInfo(self.mSkillId)    local summonid,amount = SkillConfig.getSummonInfo(base.special_set)	buffStr = SkillMgr.getBuffStr(id)	if AIMgr.getEnvir("is_door_open") == false then		if health > 0 then			if lost >= health then				self.mEvaluation = 1000			end        elseif summonid ~=nil then            local tb = GridMgr.getSummonGrids(amount)	        if #tb >= tonumber(amount) then		        self.mEvaluation = 1000	        end		elseif buffStr ~= nil then			local buff = player:getDataInfo("buff")			local total = 0			--本身没有buff状态    --FIXBUFF			--if buff.units[1].id == 0 then				--加速buff				if AIMgr.isExsitField(buffStr, "speed") then					--有技能冷却中,并要跟boss对A					if AIMgr.getEnvir("skill_on_cd") > 0 or AIMgr.getEnvir("boss") > 0 then						total = total + 700					end				end								--清洁buff				if AIMgr.isExsitField(buffStr, "cleaned") then					--身上有debuff					if BuffMgr.isDebuff(role) then						total = total + 1200 					end				end								-- 持续恢复buff				local skillInfo = SkillConfig.getSkillBaseInfo(id)				if skillInfo.skills_typelist == 112 then					local quality = skillInfo.quality					buff = SkillConfig.getSkillBuffInfo(skillInfo.caster_buff_id)					local valueTable = 					{						{name = "Q", 	value = quality},						{name = "L", 	value = level},					}					local buffInfo = SkillConfig.getSkillBuffInfo(skillInfo.caster_buff_id,skillInfo.quality,level)					local modifyTB = {}					SkillMgr.parseStatusString(modifyTB, buffInfo.modify_attribute, buffInfo.modify_value, quality, level)					local ReHp = 0					for k,v in pairs(modifyTB) do						ReHp = tonumber(v.modifyValue)*tonumber(buffInfo.duration)						break					end					if AIMgr.isExsitField(buffStr, "life") and lost > (ReHp/2) then						total = total + 1200					end				end								--危险的怪物个数								local dangerousCnt = AIMgr.getEnvir("monster_cnt") - AIMgr.getEnvir("normal_monster")				if dangerousCnt > 0 then					--攻击,暴击,命中buff					local tb1 = {"atk", "hit_ratio", "critical_ratio"}					if AIMgr.isExsitFieldWithTable(buffStr, tb1) then						--在AOE技能使用之前使用						if AIMgr.getEnvir("monster_cnt") > 2 and AIMgr.getEnvir("aoe_skill_cnt") > 0 then							total = total + 520						end												--有要对A的怪时才加这buff						if AIMgr.getEnvir("boss") > 0 and AIMgr.getEnvir("can_attack_boss") > 0 then							total = total + 820						end												--多数主动怪加这buff						if AIMgr.getEnvir("enable_attack_cnt", 1) > 0 then							total = total + math.random(10, 20)						end					end										--闪避,韧性buff					local tb2 = {"miss_ratio", "tenacity"}					if AIMgr.isExsitFieldWithTable(buffStr, tb2) then							--多数主动怪加这buff						if AIMgr.getEnvir("initiative_attack") > 0 then							total = total + 1000						end												--有要对A的怪时才加这buff						if AIMgr.getEnvir("boss") > 0  and AIMgr.getEnvir("can_attack_boss") > 0 then							total = total + 1000						end					end				--end			end			self.mEvaluation = self.mEvaluation + total		end	else		--已开门		if AIMgr.getConfig("open_door_first") == false then			if health > 0 then				if lost >= health * 0.5 then					self.mEvaluation = 1000				end			end		end	endend